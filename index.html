<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AReport - Daily Report SLA</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js & Datalabels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <!-- Font: San Francisco Alternative (Inter) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Config Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'] },
                    colors: {
                        ios: { blue: '#007AFF', blueDark: '#005ec4', gray: '#F2F2F7', light: '#FFFFFF', dark: '#1C1C1E', red: '#FF3B30', green: '#34C759', orange: '#FF9500' }
                    },
                    boxShadow: {
                        'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.07)',
                        'ios': '0 4px 24px rgba(0,0,0,0.06)'
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background: #F2F2F7; /* Apple System Gray 6 */
            background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-attachment: fixed;
            background-size: cover;
            color: #1C1C1E;
            -webkit-tap-highlight-color: transparent;
        }

        /* Glassmorphism Utilities */
        .glass-panel {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        
        .glass-nav {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.03);
        }

        /* Input Styles iOS-like */
        .ios-input {
            background: rgba(118, 118, 128, 0.12);
            border: none;
            border-radius: 10px;
            padding: 10px 14px;
            font-size: 15px;
            transition: background 0.2s;
        }
        .ios-input:focus { background: rgba(118, 118, 128, 0.2); outline: none; }
        .ios-input:disabled, .ios-input[readonly] { background: rgba(118, 118, 128, 0.05); color: #9ca3af; cursor: not-allowed; }
        
        /* Table Input */
        .input-cell input { 
            width: 100%; text-align: center; 
            background: transparent; border: none;
            border-radius: 6px; padding: 6px; font-size: 0.95rem; font-weight: 600; 
        }
        .input-cell input:focus { background: rgba(0, 122, 255, 0.1); color: #007AFF; outline: none; }
        .total-cell input { font-weight: 800; color: #007AFF; }

        /* Scrollbar Hide */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Animation */
        .animate-scale-in { animation: scaleIn 0.35s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        /* Sidebar/Nav Active */
        .nav-active { 
            background: #007AFF; 
            color: white !important; 
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3); 
        }
        .nav-active i { color: white !important; }
        .nav-item:hover:not(.nav-active) {
            background: rgba(0,0,0,0.05);
        }

        .hidden { display: none !important; }
        input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        
        /* KPI Card Hover */
        .kpi-card { transition: transform 0.2s; }
        .kpi-card:hover { transform: translateY(-2px); }

        /* Custom Widths for Dashboard Table - Equal Widths */
        .col-metric { width: 11%; text-align: right; } 
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col">

    <!-- --- LOGIN PAGE --- -->
    <div id="login-page" class="fixed inset-0 z-50 flex flex-col items-center justify-center p-6 w-full h-full bg-black/40 backdrop-blur-md">
        <div class="glass-panel w-full max-w-[340px] p-8 rounded-[32px] shadow-2xl animate-scale-in flex flex-col items-center">
            <div class="w-20 h-20 bg-gradient-to-tr from-blue-500 to-cyan-400 rounded-[22px] flex items-center justify-center mb-6 shadow-lg shadow-blue-500/30">
                <i class="fa-solid fa-file-contract text-white text-3xl"></i>
            </div>
            <h1 class="text-2xl font-bold text-slate-800 mb-1">AReport</h1>
            <p class="text-slate-500 text-sm mb-8 font-medium">Daily Report SLA</p>

            <div class="bg-slate-200/50 p-1 rounded-xl w-full flex mb-6 relative">
                <div class="w-full grid grid-cols-2 relative z-10">
                    <button onclick="switchLoginTab('user')" id="tab-login-user" class="py-1.5 text-xs font-bold rounded-lg transition-all shadow-sm bg-white text-slate-800">PIC</button>
                    <button onclick="switchLoginTab('admin')" id="tab-login-admin" class="py-1.5 text-xs font-bold rounded-lg transition-all text-slate-500">Admin</button>
                </div>
            </div>

            <form id="login-form" class="w-full space-y-4">
                <input type="hidden" id="login-type" value="user">
                <div id="login-intro-text" class="hidden"></div>
                <div id="username-container">
                    <input type="text" id="username" class="ios-input w-full text-center font-medium placeholder:text-slate-400" placeholder="ID (Angka)" required>
                </div>
                <div>
                    <input type="password" id="password" class="ios-input w-full text-center font-medium placeholder:text-slate-400" placeholder="Password" required>
                </div>
                <button type="submit" class="w-full bg-[#007AFF] hover:bg-[#0062cc] text-white font-bold py-3.5 rounded-2xl shadow-lg shadow-blue-500/20 active:scale-95 transition-all mt-2">
                    Masuk
                </button>
            </form>
            <div id="login-error" class="mt-4 text-center text-red-500 text-xs font-bold hidden bg-red-50 px-3 py-2 rounded-lg">
                <i class="fa-solid fa-circle-exclamation mr-1"></i> <span></span>
            </div>
        </div>
    </div>


    <!-- --- MAIN APP --- -->
    <div id="main-app" class="hidden flex-1 flex flex-col relative">
        
        <!-- TOP NAVIGATION -->
        <header class="fixed top-0 left-0 right-0 z-40 glass-nav h-20 px-4 md:px-8 flex items-center justify-between">
            <div class="flex items-center gap-3 shrink-0">
                <div class="w-10 h-10 bg-gradient-to-b from-blue-500 to-blue-600 rounded-xl flex items-center justify-center text-white shadow-md">
                    <i class="fa-solid fa-chart-simple text-sm"></i>
                </div>
                <div class="hidden md:flex flex-col">
                    <span class="font-bold text-slate-800 text-lg leading-tight">AReport</span>
                    <span class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">Dashboard Pro</span>
                </div>
            </div>

            <nav class="flex-1 flex justify-center mx-4 overflow-x-auto no-scrollbar">
                <div class="flex items-center bg-slate-100/70 p-1 rounded-2xl border border-slate-200/50 backdrop-blur-md">
                    <button onclick="showTab('dashboard')" id="nav-dashboard" class="nav-item nav-active px-4 py-2 rounded-xl text-xs md:text-sm font-bold text-slate-500 transition-all flex items-center gap-2 whitespace-nowrap">
                        <i class="fa-solid fa-table-columns"></i> <span>Dashboard</span>
                    </button>
                    <button onclick="showTab('reports')" id="nav-reports" class="nav-item px-4 py-2 rounded-xl text-xs md:text-sm font-bold text-slate-500 transition-all flex items-center gap-2 whitespace-nowrap">
                        <i class="fa-solid fa-list-check"></i> <span>Riwayat Laporan</span>
                    </button>
                    <button onclick="showTab('settings')" id="nav-settings" class="nav-item hidden px-4 py-2 rounded-xl text-xs md:text-sm font-bold text-slate-500 transition-all flex items-center gap-2 whitespace-nowrap">
                        <i class="fa-solid fa-users-gear"></i> <span>Admin</span>
                    </button>
                </div>
            </nav>

            <div class="flex items-center gap-3 shrink-0">
                <div class="text-right hidden sm:block">
                    <p id="user-display-name" class="text-xs font-bold text-slate-800">User</p>
                    <p id="user-display-role" class="text-[9px] text-blue-500 font-bold uppercase">Role</p>
                </div>
                <div class="w-9 h-9 rounded-full bg-slate-200 flex items-center justify-center text-slate-500 font-bold text-xs border border-white shadow-sm" id="avatar-initials">U</div>
                <button onclick="logout()" class="w-9 h-9 bg-slate-100 hover:bg-red-50 text-slate-400 hover:text-red-500 rounded-full flex items-center justify-center transition-colors border border-slate-200" title="Keluar">
                    <i class="fa-solid fa-power-off text-xs"></i>
                </button>
            </div>
        </header>

        <!-- CONTENT AREA (SUPER WIDE) -->
        <main class="flex-1 w-full max-w-[1920px] mx-auto pt-24 px-4 md:px-8 lg:px-12 pb-10 animate-scale-in">
            
            <!-- 1. DASHBOARD TAB -->
            <div id="tab-dashboard" class="space-y-6">
                <!-- Greeting Card -->
                <div class="glass-panel p-6 md:p-8 rounded-[32px] relative overflow-hidden">
                    <div class="relative z-10">
                        <h2 class="text-2xl md:text-3xl font-bold text-slate-800 mb-1">Overview</h2>
                        <p class="text-slate-500 text-sm">Selamat datang kembali, <span id="dashboard-greeting-name" class="text-blue-600 font-bold">User</span>.</p>
                    </div>
                    <div class="absolute -top-10 -right-10 w-40 h-40 bg-blue-400/20 rounded-full blur-3xl"></div>
                </div>

                <!-- Filter Bar -->
                <div class="glass-panel p-2 rounded-2xl flex flex-col md:flex-row gap-2 md:items-center overflow-x-auto">
                    <div class="flex items-center bg-slate-100/50 rounded-xl px-3 py-1.5 gap-2 border border-slate-200/50">
                        <i class="fa-regular fa-calendar text-slate-400 text-xs"></i>
                        <input type="date" id="dash-date-start" class="bg-transparent text-xs font-bold text-slate-600 outline-none w-24">
                        <span class="text-slate-300 text-xs">→</span>
                        <input type="date" id="dash-date-end" class="bg-transparent text-xs font-bold text-slate-600 outline-none w-24">
                    </div>
                    <div class="h-6 w-px bg-slate-200 hidden md:block"></div>
                    <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1 md:pb-0 items-center">
                        <select id="dash-filter-ss" class="ios-input py-1.5 px-3 text-xs font-bold bg-slate-100/50 rounded-xl min-w-[100px]"><option value="all">Semua SS</option></select>
                        <select id="dash-filter-service" class="ios-input py-1.5 px-3 text-xs font-bold bg-slate-100/50 rounded-xl min-w-[100px]">
                            <option value="all">All Svc</option><option value="REG">REG</option><option value="ECO">ECO</option><option value="ND">ND</option><option value="SD/SDS">SD/SDS</option><option value="BIG">BIG</option>
                        </select>
                        <select id="dash-filter-type" class="ios-input py-1.5 px-3 text-xs font-bold bg-slate-100/50 rounded-xl min-w-[100px]">
                            <option value="all">All Type</option><option value="delivery">Del</option><option value="pickup">Pick</option>
                        </select>
                        <!-- Reset Button -->
                        <button onclick="resetFilters()" class="bg-slate-200 hover:bg-slate-300 text-slate-600 rounded-xl px-3 py-1.5 text-xs font-bold transition-colors ml-2" title="Reset Filter">
                            <i class="fa-solid fa-rotate-right"></i>
                        </button>
                    </div>
                </div>

                <!-- KPI CARDS GRID -->
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                    <!-- Total -->
                    <div class="glass-panel p-4 rounded-3xl kpi-card flex flex-col justify-between h-32 relative">
                        <div class="w-10 h-10 bg-blue-100 text-blue-600 rounded-2xl flex items-center justify-center mb-2"><i class="fa-solid fa-layer-group"></i></div>
                        <div><p class="text-xs font-bold text-slate-400 uppercase">Total</p><h3 id="kpi-val-total" class="text-2xl font-bold text-slate-800">0</h3></div>
                    </div>
                    <!-- OK -->
                    <div class="glass-panel p-4 rounded-3xl kpi-card flex flex-col justify-between h-32 relative">
                        <div class="absolute top-4 right-4 bg-green-100 text-green-700 text-[10px] font-bold px-2 py-1 rounded-full" id="kpi-badge-ok">0%</div>
                        <div class="w-10 h-10 bg-green-100 text-green-600 rounded-2xl flex items-center justify-center mb-2"><i class="fa-solid fa-check-circle"></i></div>
                        <div><p class="text-xs font-bold text-slate-400 uppercase">OK</p><h3 id="kpi-val-ok" class="text-2xl font-bold text-slate-800">0</h3></div>
                    </div>
                    <!-- Inprogress -->
                    <div class="glass-panel p-4 rounded-3xl kpi-card flex flex-col justify-between h-32 relative">
                        <div class="w-10 h-10 bg-indigo-100 text-indigo-600 rounded-2xl flex items-center justify-center mb-2"><i class="fa-solid fa-spinner"></i></div>
                        <div><p class="text-xs font-bold text-slate-400 uppercase">Inprog</p><h3 id="kpi-val-prog" class="text-2xl font-bold text-slate-800">0</h3></div>
                    </div>
                    <!-- MBH -->
                    <div class="glass-panel p-4 rounded-3xl kpi-card flex flex-col justify-between h-32 relative">
                        <div class="w-10 h-10 bg-orange-100 text-orange-600 rounded-2xl flex items-center justify-center mb-2"><i class="fa-solid fa-hourglass-half"></i></div>
                        <div><p class="text-xs font-bold text-slate-400 uppercase">MBH</p><h3 id="kpi-val-mbh" class="text-2xl font-bold text-slate-800">0</h3></div>
                    </div>
                    <!-- Missed -->
                    <div class="glass-panel p-4 rounded-3xl kpi-card flex flex-col justify-between h-32 relative">
                        <div class="w-10 h-10 bg-red-100 text-red-600 rounded-2xl flex items-center justify-center mb-2"><i class="fa-solid fa-circle-xmark"></i></div>
                        <div><p class="text-xs font-bold text-slate-400 uppercase">Missed</p><h3 id="kpi-val-miss" class="text-2xl font-bold text-red-600">0</h3></div>
                    </div>
                    <!-- Claimed -->
                    <div class="glass-panel p-4 rounded-3xl kpi-card flex flex-col justify-between h-32 relative" id="kpi-card-claim">
                        <div class="w-10 h-10 bg-purple-100 text-purple-600 rounded-2xl flex items-center justify-center mb-2"><i class="fa-solid fa-file-invoice-dollar"></i></div>
                        <div><p class="text-xs font-bold text-slate-400 uppercase">Claim</p><h3 id="kpi-val-claim" class="text-2xl font-bold text-slate-800">0</h3></div>
                    </div>
                </div>

                <!-- Charts (Full Width) -->
                <div class="space-y-6">
                    <div class="glass-panel p-6 md:p-8 rounded-[32px] h-[400px] flex flex-col">
                        <h3 class="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2"><i class="fa-regular fa-calendar text-blue-500"></i> Tren Tahunan</h3>
                        <div class="flex-1 w-full relative"><canvas id="chartAnnual"></canvas></div>
                    </div>
                    <div class="glass-panel p-6 md:p-8 rounded-[32px] h-[400px] flex flex-col">
                        <h3 class="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2"><i class="fa-solid fa-chart-line text-green-500"></i> Performa 30 Hari</h3>
                        <div class="flex-1 w-full relative"><canvas id="chartMonthly"></canvas></div>
                    </div>
                </div>

                <!-- Tables (Full Columns + Total Footer) -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="glass-panel rounded-[28px] overflow-hidden flex flex-col">
                        <div class="p-5 border-b border-black/5 bg-slate-50/30">
                            <h3 class="text-sm font-bold text-slate-800">Staging Performance</h3>
                        </div>
                        <div class="overflow-x-auto p-2">
                            <table class="w-full text-xs text-left border-collapse">
                                <thead class="text-slate-400 font-semibold border-b border-black/5 bg-slate-50/20">
                                    <tr>
                                        <th class="p-3 pl-4">SS</th>
                                        <th class="p-3 col-metric">Total</th>
                                        <th class="p-3 col-metric">OK</th>
                                        <th class="p-3 col-metric text-center">%OK</th>
                                        <th class="p-3 col-metric text-slate-500">Inprog</th>
                                        <th class="p-3 col-metric text-orange-500">MBH</th>
                                        <th class="p-3 col-metric text-red-500">Miss</th>
                                        <th class="p-3 col-metric pr-4 text-purple-500 claim-col">Claim</th>
                                    </tr>
                                </thead>
                                <tbody id="body-breakdown-staging" class="divide-y divide-black/5"></tbody>
                                <tfoot id="foot-breakdown-staging" class="bg-slate-100/50 font-bold text-slate-800 border-t border-black/10"></tfoot>
                            </table>
                        </div>
                    </div>
                    <div class="glass-panel rounded-[28px] overflow-hidden flex flex-col">
                        <div class="p-5 border-b border-black/5 bg-slate-50/30">
                            <h3 class="text-sm font-bold text-slate-800">Service Breakdown</h3>
                        </div>
                        <div class="overflow-x-auto p-2">
                            <table class="w-full text-xs text-left border-collapse">
                                <thead class="text-slate-400 font-semibold border-b border-black/5 bg-slate-50/20">
                                    <tr>
                                        <th class="p-3 pl-4">Svc</th>
                                        <th class="p-3 col-metric">Total</th>
                                        <th class="p-3 col-metric">OK</th>
                                        <th class="p-3 col-metric text-center">%OK</th>
                                        <th class="p-3 col-metric text-slate-500">Inprog</th>
                                        <th class="p-3 col-metric text-orange-500">MBH</th>
                                        <th class="p-3 col-metric text-red-500">Miss</th>
                                        <th class="p-3 col-metric pr-4 text-purple-500 claim-col">Claim</th>
                                    </tr>
                                </thead>
                                <tbody id="body-breakdown-service" class="divide-y divide-black/5"></tbody>
                                <tfoot id="foot-breakdown-service" class="bg-slate-100/50 font-bold text-slate-800 border-t border-black/10"></tfoot>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Feedback -->
                <div class="glass-panel p-6 rounded-[28px]">
                    <h3 class="text-sm font-bold text-slate-800 mb-4">Feedback Issues</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-blue-50/50 rounded-2xl p-4 border border-blue-100/50">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs font-bold text-blue-600">INTERNAL</span>
                                <span id="feedback-total-int" class="font-bold text-lg text-blue-700">0</span>
                            </div>
                            <ul id="feedback-list-int" class="text-xs space-y-1 max-h-32 overflow-y-auto no-scrollbar"></ul>
                        </div>
                        <div class="bg-orange-50/50 rounded-2xl p-4 border border-orange-100/50">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs font-bold text-orange-600">EXTERNAL</span>
                                <span id="feedback-total-ext" class="font-bold text-lg text-orange-700">0</span>
                            </div>
                            <ul id="feedback-list-ext" class="text-xs space-y-1 max-h-32 overflow-y-auto no-scrollbar"></ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. REPORTS TAB (FULL HISTORY + FORM TOGGLE) -->
            <div id="tab-reports" class="hidden space-y-6">
                <!-- HISTORY VIEW -->
                <div id="view-reports-list" class="glass-panel rounded-[32px] p-6 animate-scale-in">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="text-lg font-bold text-slate-800">Riwayat Laporan</h3>
                            <p class="text-xs text-slate-500">Daftar laporan harian tim.</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="relative">
                                <select id="filter-user" class="ios-input py-2 px-4 text-xs font-bold pr-8 appearance-none"><option value="all">Semua PIC</option></select>
                                <div class="absolute inset-y-0 right-2 flex items-center pointer-events-none text-slate-400"><i class="fa-solid fa-chevron-down text-[10px]"></i></div>
                            </div>
                            <button onclick="toggleReportForm(true)" class="bg-[#007AFF] hover:bg-[#0062cc] text-white w-9 h-9 rounded-full shadow-lg shadow-blue-500/30 flex items-center justify-center transition-all transform hover:scale-105">
                                <i class="fa-solid fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead class="text-slate-400 text-[10px] uppercase font-bold border-b border-black/5 bg-slate-50/50">
                                <tr>
                                    <th class="p-3 w-24">Tgl</th>
                                    <th class="p-3 w-32">Identitas</th>
                                    <th class="p-3 w-20">Tipe</th>
                                    <th class="p-3">Rincian Per Service</th>
                                    <th class="p-3 text-center w-16">Int</th>
                                    <th class="p-3 text-center w-16">Ext</th>
                                    <th class="p-3 w-64">Feedback</th>
                                    <th class="p-3 text-center w-24">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="reports-table-body" class="text-xs font-medium divide-y divide-black/5"></tbody>
                        </table>
                    </div>
                </div>

                <!-- INPUT FORM VIEW (Hidden by default) -->
                <div id="view-reports-form" class="hidden glass-panel rounded-[32px] p-6 md:p-8 relative animate-scale-in">
                     <div id="edit-mode-indicator" class="hidden absolute top-0 left-0 right-0 bg-yellow-400 text-white text-center py-1 text-xs font-bold rounded-t-[32px] z-20">
                        Mode Edit Laporan
                    </div>
                    
                    <div class="flex justify-between items-center mb-6 mt-2">
                        <div class="flex items-center gap-3">
                            <button onclick="toggleReportForm(false); cancelEditMode()" class="w-8 h-8 rounded-full bg-slate-100 hover:bg-slate-200 text-slate-600 flex items-center justify-center transition-colors">
                                <i class="fa-solid fa-arrow-left"></i>
                            </button>
                            <h2 class="text-xl font-bold text-slate-800">Form Input Laporan</h2>
                        </div>
                    </div>

                    <form id="report-form" class="space-y-6">
                        <input type="hidden" id="report-id-hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-white/40 p-4 rounded-2xl border border-white/50">
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-3 ml-1">Tanggal & Tipe</label>
                                <div class="flex flex-col gap-3">
                                    <input type="date" id="input-date" class="ios-input w-full font-bold text-slate-700">
                                    <!-- Custom Segmented Control for Type -->
                                    <div class="bg-slate-200/50 p-1 rounded-xl flex">
                                        <button type="button" onclick="selectReportType('delivery')" id="btn-type-delivery" class="flex-1 py-2 rounded-lg text-xs font-bold flex items-center justify-center gap-2 transition-all shadow-sm bg-white text-[#007AFF]">
                                            <i class="fa-solid fa-truck"></i> Delivery
                                        </button>
                                        <button type="button" onclick="selectReportType('pickup')" id="btn-type-pickup" class="flex-1 py-2 rounded-lg text-xs font-bold flex items-center justify-center gap-2 transition-all text-slate-500">
                                            <i class="fa-solid fa-box-open"></i> Pickup
                                        </button>
                                    </div>
                                    <input type="hidden" id="input-type" value="delivery">
                                </div>
                            </div>
                            <div class="bg-white/40 p-4 rounded-2xl border border-white/50">
                                <div id="admin-user-select-container" class="hidden mb-2">
                                    <label class="block text-[10px] font-bold text-blue-500 uppercase mb-1 ml-1">Pilih User (Admin)</label>
                                    <select id="input-admin-select-user" onchange="updateReporterInfo()" class="ios-input w-full text-xs"><option value="">-- Pilih --</option></select>
                                </div>
                                <div id="leader-user-info" class="flex gap-2">
                                    <div class="w-full"><label class="block text-xs font-bold text-slate-400 uppercase mb-1 ml-1">PIC</label><input type="text" id="input-pic-name" class="ios-input w-full text-slate-600 font-bold bg-slate-100/50" readonly><input type="hidden" id="input-pic-id"></div>
                                    <div class="w-24 shrink-0"><label class="block text-xs font-bold text-slate-400 uppercase mb-1 ml-1">SS</label><input type="text" id="input-kode-ss" class="ios-input w-full text-slate-600 font-bold bg-slate-100/50 text-center" readonly></div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white/50 rounded-2xl overflow-hidden border border-white/60 shadow-sm">
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm border-collapse"><thead id="table-header" class="bg-slate-50/50 text-slate-500 font-bold text-xs uppercase text-center border-b border-slate-200"></thead><tbody id="table-body" class="divide-y divide-slate-100"></tbody></table>
                            </div>
                        </div>
                        <div class="flex justify-end pt-2">
                            <button type="submit" id="btn-submit-report" class="bg-[#007AFF] hover:bg-[#0062cc] text-white font-bold py-3.5 px-8 rounded-2xl shadow-lg shadow-blue-500/20 active:scale-95 transition-all flex items-center gap-2">
                                <i class="fa-solid fa-paper-plane"></i> <span id="btn-submit-text">Simpan Laporan</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 3. SETTINGS TAB -->
            <div id="tab-settings" class="hidden space-y-6">
                <div class="glass-panel p-6 rounded-[32px] flex flex-col md:flex-row gap-4 items-end">
                    <div class="w-full"><label class="text-xs font-bold text-slate-500 uppercase ml-1">Security Code</label><input type="text" id="setting-admin-code" class="ios-input w-full mt-1 text-center font-mono tracking-[4px] text-lg font-bold text-slate-700" placeholder="••••••"></div>
                    <button onclick="saveGlobalSettings()" class="bg-slate-800 text-white font-bold py-3 px-6 rounded-2xl text-sm w-full md:w-auto">Save</button>
                </div>
                <div class="glass-panel rounded-[32px] overflow-hidden flex flex-col">
                    <div class="p-5 border-b border-black/5 bg-slate-50/30 flex justify-between items-center"><h3 class="text-sm font-bold text-slate-800">Team Users</h3><button onclick="prepareAddUser()" class="bg-[#007AFF] text-white p-2 rounded-lg text-xs font-bold"><i class="fa-solid fa-plus"></i></button></div>
                    <div class="overflow-x-auto"><table class="w-full text-left text-sm"><thead class="text-slate-400 text-xs font-bold bg-slate-50/50"><tr><th class="p-4">Nama</th><th class="p-4">Role</th><th class="p-4 text-center">Status</th><th class="p-4 text-center">Edit</th></tr></thead><tbody id="users-table-body" class="divide-y divide-black/5 text-xs"></tbody></table></div>
                </div>
            </div>

        </main>
    </div>

    <!-- MODALS -->
    <div id="modal-add-user" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden z-50 flex items-center justify-center p-6">
        <div class="bg-white/90 backdrop-blur-xl w-full max-w-sm rounded-[24px] p-6 shadow-2xl animate-scale-in">
            <div class="flex justify-between items-center mb-4"><h3 id="modal-title" class="font-bold text-lg">User Baru</h3><button onclick="closeAddUserModal()" class="w-8 h-8 bg-slate-200 rounded-full text-slate-500"><i class="fa-solid fa-xmark"></i></button></div>
            <form id="add-user-form" class="space-y-3">
                <input type="hidden" id="edit-user-id">
                <div class="grid grid-cols-2 gap-3">
                    <select id="new-role" onchange="toggleFormFields()" class="ios-input w-full text-xs font-bold">
                        <option value="leader">Leader</option>
                        <option value="coordinator">Coordinator</option>
                    </select>
                    <select id="new-account-status" class="ios-input w-full text-xs font-bold"><option value="active">Active</option><option value="inactive">Inactive</option></select>
                </div>
                <input type="text" id="new-name" class="ios-input w-full font-bold" placeholder="Nama Lengkap" required>
                <div class="grid grid-cols-2 gap-3"><input type="text" id="new-username" class="ios-input w-full" placeholder="ID (Angka)" required><input type="text" id="new-password" class="ios-input w-full" placeholder="Password (Min 6)" required></div>
                <div id="leader-fields" class="grid grid-cols-2 gap-3"><input type="text" id="new-kode-ss" class="ios-input w-full" placeholder="Kode SS"><input type="text" id="new-kota" class="ios-input w-full" placeholder="Kota"></div>
                <button type="submit" class="w-full bg-[#007AFF] text-white font-bold py-3 rounded-xl mt-2">Simpan</button>
            </form>
        </div>
    </div>

    <div id="modal-auth-code" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden z-50 flex items-center justify-center p-6">
        <div class="bg-white/90 backdrop-blur-xl w-full max-w-xs rounded-[24px] p-6 shadow-2xl text-center animate-scale-in">
            <h3 class="font-bold text-lg mb-1">Security Check</h3><p class="text-xs text-slate-500 mb-4">Masukkan kode admin.</p><input type="password" id="auth-code-input" class="ios-input w-full text-center tracking-[4px] text-lg font-bold mb-4" placeholder="••••••">
            <div class="grid grid-cols-2 gap-3"><button onclick="closeAuthModal()" class="py-2.5 bg-slate-200 rounded-xl font-bold text-xs text-slate-600">Batal</button><button onclick="verifyAuthCode()" class="py-2.5 bg-[#007AFF] text-white rounded-xl font-bold text-xs">Verifikasi</button></div>
        </div>
    </div>
    
    <div id="modal-confirm-delete" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden z-50 flex items-center justify-center p-6">
        <div class="bg-white/90 backdrop-blur-xl w-full max-w-xs rounded-[24px] p-6 shadow-2xl text-center animate-scale-in">
            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-3 text-red-500 text-xl"><i class="fa-solid fa-trash-can"></i></div>
            <h3 class="font-bold text-lg mb-1">Hapus Data?</h3><p id="delete-confirmation-text" class="text-xs text-slate-500 mb-4">Tindakan ini permanen.</p>
            <div class="grid grid-cols-2 gap-3"><button onclick="closeDeleteModal()" class="py-2.5 bg-slate-200 rounded-xl font-bold text-xs text-slate-600">Batal</button><button onclick="executeDelete()" class="py-2.5 bg-red-500 text-white rounded-xl font-bold text-xs">Hapus</button></div>
        </div>
    </div>

    <div id="toast-container" class="fixed top-24 right-1/2 translate-x-1/2 md:translate-x-0 md:right-6 z-[100] flex flex-col gap-2 w-max max-w-[90%]"></div>

    <!-- JAVASCRIPT LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, onSnapshot, deleteDoc, updateDoc, doc, getDoc, setDoc, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Register Plugin Chart JS Datalabels
        Chart.register(ChartDataLabels);

        const firebaseConfig = { apiKey: "AIzaSyAqbDeVLDBRDEIfi4RliLMC-3Qrwh8p96k", authDomain: "logsheet-5r.firebaseapp.com", projectId: "logsheet-5r", storageBucket: "logsheet-5r.firebasestorage.app", messagingSenderId: "358725557740", appId: "1:358725557740:web:664cca8d2ae984221ff4c9" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let currentUser = null, allReports = [], allUsers = [], chartAnnual = null, chartMonthly = null;
        let pendingAction = null, targetId = null, currentAdminCode = "123456";
        const ROW_LABELS = ['REG', 'ECO', 'ND', 'SD/SDS', 'BIG'];
        let reportsUnsubscribe = null, usersUnsubscribe = null;

        // AUTH INIT
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth failed", error);
            }
        };
        onAuthStateChanged(auth, (user) => { if(!user) initAuth(); });
        initAuth();

        function showNotification(msg, type='success') {
            const div = document.createElement('div');
            div.className = `glass-panel px-4 py-3 rounded-full shadow-lg text-xs font-bold flex items-center gap-2 animate-scale-in text-slate-800 border-l-4 ${type==='success'?'border-green-500':'border-red-500'}`;
            div.innerHTML = `<i class="fa-solid ${type==='success'?'fa-check text-green-500':'fa-xmark text-red-500'}"></i> ${msg}`;
            document.getElementById('toast-container').appendChild(div);
            setTimeout(()=>div.remove(),3000);
        }
        window.showNotification = showNotification;

        window.switchLoginTab = (type) => {
            document.getElementById('login-type').value = type;
            const uInput = document.getElementById('username-container');
            const btnUser = document.getElementById('tab-login-user');
            const btnAdmin = document.getElementById('tab-login-admin');
            
            if(type==='admin') {
                btnAdmin.className = "py-1.5 text-xs font-bold rounded-lg transition-all shadow-sm bg-white text-slate-800";
                btnUser.className = "py-1.5 text-xs font-bold rounded-lg transition-all text-slate-500";
                uInput.classList.add('hidden'); document.getElementById('username').value='admin';
            } else {
                btnUser.className = "py-1.5 text-xs font-bold rounded-lg transition-all shadow-sm bg-white text-slate-800";
                btnAdmin.className = "py-1.5 text-xs font-bold rounded-lg transition-all text-slate-500";
                uInput.classList.remove('hidden'); if(document.getElementById('username').value==='admin') document.getElementById('username').value='';
            }
        }

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const type = document.getElementById('login-type').value;
            const u = document.getElementById('username').value.trim().toLowerCase();
            const p = document.getElementById('password').value.trim();
            const errEl = document.getElementById('login-error');
            
            try {
                if (!auth.currentUser) await initAuth();
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'users'), where("username", "==", u));
                const snap = await getDocs(q);
                
                if(!snap.empty) {
                    const data = snap.docs[0].data();
                    if(data.password !== p) throw new Error("Password salah.");
                    if(data.status === 'inactive') throw new Error("Akun Non-Aktif.");
                    if(type === 'admin' && u !== 'admin') throw new Error("Bukan akun Admin.");
                    if(type === 'user' && u === 'admin') throw new Error("Gunakan tab Admin.");
                    currentUser = { id: snap.docs[0].id, ...data };
                    finishLogin();
                } else {
                    if(type==='admin' && u==='admin' && p==='TAB123') {
                        // Cek apakah sudah ada admin lain (role coordinator)
                        const qCoord = query(collection(db, 'artifacts', appId, 'public', 'data', 'users'), where("role", "==", "coordinator"));
                        const snapCoord = await getDocs(qCoord);
                        
                        if (snapCoord.empty) {
                            const newAdm = {name:"Super Admin", username:"admin", password:"TAB123", role:"coordinator", status:"active", createdAt:serverTimestamp()};
                            const ref = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'users'), newAdm);
                            currentUser = {id:ref.id, ...newAdm};
                            finishLogin();
                        } else {
                            throw new Error("Username tidak ditemukan.");
                        }
                    } else throw new Error("Username tidak ditemukan.");
                }
            } catch(err) {
                errEl.querySelector('span').textContent = err.message;
                errEl.classList.remove('hidden');
            }
        });

        function finishLogin() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('user-display-name').textContent = currentUser.name;
            document.getElementById('dashboard-greeting-name').textContent = currentUser.name;
            document.getElementById('user-display-role').textContent = currentUser.role;
            document.getElementById('avatar-initials').textContent = currentUser.name.charAt(0).toUpperCase();

            // FIX: Ensure correct visibility state on login
            const navSettings = document.getElementById('nav-settings');
            if(currentUser.role === 'coordinator') {
                navSettings.classList.remove('hidden');
                navSettings.classList.add('flex');
            } else {
                navSettings.classList.add('hidden');
                navSettings.classList.remove('flex');
            }
            
            fetchGlobalSettings(); 
            listenToReports();
            if(currentUser.role === 'coordinator') listenToUsers();
            setupReportForm(); setupDashboardFilters(); renderInputTable(); window.showTab('dashboard');
        }

        async function logout() {
            try {
                if(reportsUnsubscribe) reportsUnsubscribe(); 
                if(usersUnsubscribe) usersUnsubscribe();
                currentUser = null; allReports = []; allUsers = [];
                
                document.getElementById('main-app').classList.add('hidden');
                document.getElementById('login-page').classList.remove('hidden');
                
                // FIX: Reset Admin Menu Visibility to HIDDEN by default
                const navSettings = document.getElementById('nav-settings');
                navSettings.classList.add('hidden');
                navSettings.classList.remove('flex');

                document.getElementById('login-form').reset(); 
                document.getElementById('login-error').classList.add('hidden');
                switchLoginTab('user');
            } catch (error) { window.location.reload(); }
        }
        window.logout = logout;

        async function fetchGlobalSettings() {
            if(!auth.currentUser) return;
            const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'globalConfig'));
            if(snap.exists()) {
                currentAdminCode = snap.data().adminCode || "123456";
                const inp = document.getElementById('setting-admin-code'); if(inp) inp.value = currentAdminCode;
            } else { setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'globalConfig'), {adminCode: "123456"}); }
        }
        window.saveGlobalSettings = async () => {
            const code = document.getElementById('setting-admin-code').value.trim();
            if(!code) return showNotification("Kode kosong", "error");
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'globalConfig'), {adminCode: code}, {merge:true});
            currentAdminCode = code; showNotification("Disimpan!");
        }

        function setupDashboardFilters() {
            const ssSet = new Set(allReports.map(r => r.kodeSS).filter(Boolean));
            const ssSel = document.getElementById('dash-filter-ss');
            if(ssSel) {
                const cur = ssSel.value;
                ssSel.innerHTML = '<option value="all">Semua SS</option>' + [...ssSet].map(ss => `<option value="${ss}">${ss}</option>`).join('');
                if([...ssSet].includes(cur)) ssSel.value = cur;
            }
            const now = new Date();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
            const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
            const startIn = document.getElementById('dash-date-start');
            const endIn = document.getElementById('dash-date-end');
            if(startIn && !startIn.value) startIn.value = firstDay;
            if(endIn && !endIn.value) endIn.value = lastDay;

            ['dash-date-start', 'dash-date-end', 'dash-filter-ss', 'dash-filter-service', 'dash-filter-type'].forEach(id => {
                const el = document.getElementById(id); if(el) el.addEventListener('change', renderDashboard);
            });
        }

        window.resetFilters = () => {
            const now = new Date();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
            const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
            document.getElementById('dash-date-start').value = firstDay;
            document.getElementById('dash-date-end').value = lastDay;
            document.getElementById('dash-filter-ss').value = 'all';
            document.getElementById('dash-filter-service').value = 'all';
            document.getElementById('dash-filter-type').value = 'all';
            renderDashboard();
        }

        function renderDashboard() {
            if(!document.getElementById('dash-date-start')) return;
            const start = document.getElementById('dash-date-start').value;
            const end = document.getElementById('dash-date-end').value;
            const fSS = document.getElementById('dash-filter-ss').value;
            const fSvc = document.getElementById('dash-filter-service').value;
            const fType = document.getElementById('dash-filter-type').value;

            // Separate filter for standard widgets (respects date)
            const filteredByDate = allReports.filter(r => {
                const rDate = r.date || new Date(r.timestamp.seconds*1000).toISOString().split('T')[0];
                const inDate = (!start || rDate >= start) && (!end || rDate <= end);
                const inSS = fSS === 'all' || r.kodeSS === fSS;
                const inType = fType === 'all' || r.type === fType;
                const inSvc = fSvc === 'all' || r.details.some(d => d.label === fSvc && d.total > 0); // Rough check
                return inDate && inSS && inType; // Svc check inside processBreakdowns usually
            });
            
            // Separate filter for Annual Chart (Ignores Date)
            const filteredForAnnual = allReports.filter(r => {
                const inSS = fSS === 'all' || r.kodeSS === fSS;
                const inType = fType === 'all' || r.type === fType;
                 // Svc check is complex for totals, usually charts aggregate all unless specific breakdown requested.
                 // For now, respect SS and Type for Annual.
                return inSS && inType;
            });

            updateKPIs(filteredByDate, fType);
            processCharts(filteredByDate, filteredForAnnual); 
            processBreakdowns(filteredByDate, fSvc, fType); 
            processFeedback(filteredByDate);
        }

        function updateKPIs(data, filterType) {
            let total = 0, ok = 0, prog = 0, mbh = 0, miss = 0, claim = 0;
            data.forEach(r => {
                r.details?.forEach(d => {
                    total += d.total; ok += d.ok; prog += d.inprogress; mbh += d.mbh; miss += d.missed; claim += d.claimed;
                });
            });
            const pct = total > 0 ? (ok/total*100).toFixed(1) : 0;
            
            document.getElementById('kpi-val-total').textContent = total.toLocaleString('id-ID');
            document.getElementById('kpi-val-ok').textContent = ok.toLocaleString('id-ID');
            document.getElementById('kpi-badge-ok').textContent = pct.toLocaleString('id-ID') + '%';
            document.getElementById('kpi-val-prog').textContent = prog.toLocaleString('id-ID');
            document.getElementById('kpi-val-mbh').textContent = mbh.toLocaleString('id-ID');
            document.getElementById('kpi-val-miss').textContent = miss.toLocaleString('id-ID');
            document.getElementById('kpi-val-claim').textContent = claim.toLocaleString('id-ID');

            const isPickup = filterType === 'pickup';
            document.getElementById('kpi-card-claim').style.display = isPickup ? 'none' : 'flex';
        }

        function processCharts(dataByDate, dataAnnual) {
            const chartAnnualCanvas = document.getElementById('chartAnnual');
            const chartMonthlyCanvas = document.getElementById('chartMonthly');
            if(!chartAnnualCanvas || !chartMonthlyCanvas) return;

            // --- Annual Chart (Uses dataAnnual - Ignores Date Filter) ---
            const months = {};
            // Init with 0 for Jan-Dec
            for(let i=0; i<12; i++) { 
                const m = new Date(new Date().getFullYear(), i, 1).toLocaleString('id-ID',{month:'short'}); 
                months[m] = {total:0, ok:0}; 
            }
            dataAnnual.forEach(r => {
                const dateVal = r.date ? new Date(r.date) : (r.timestamp ? new Date(r.timestamp.seconds*1000) : new Date());
                // Only consider current year for "Annual Trend" usually, or just aggregate all if simple
                if(dateVal.getFullYear() === new Date().getFullYear()) {
                     const m = dateVal.toLocaleString('id-ID',{month:'short'});
                     let rTotal = 0, rOK = 0; r.details?.forEach(d => { rTotal+=d.total; rOK+=d.ok; });
                     if(months[m]) { months[m].total+=rTotal; months[m].ok+=rOK; }
                }
            });
            const keysM = Object.keys(months);
            const datM_Vol = keysM.map(k=>months[k].total);
            const datM_SLA = keysM.map(k=> months[k].total>0 ? ((months[k].ok/months[k].total)*100).toFixed(1) : 0);

            if(chartAnnual) chartAnnual.destroy();
            chartAnnual = new Chart(chartAnnualCanvas, {
                type: 'bar',
                data: { labels: keysM, datasets: [{ type:'bar', label:'Vol', data:datM_Vol, backgroundColor:'#007AFF', borderRadius:4, order:2 }, { type:'line', label:'% SLA', data:datM_SLA, borderColor:'#FF9500', borderWidth:3, tension:0.3, pointRadius:3, yAxisID:'y1', order:1 }] },
                options: { 
                    layout: { padding: { top: 20 } },
                    responsive:true, maintainAspectRatio:false, 
                    plugins:{ 
                        legend:{display:false},
                        datalabels: {
                            color: (context) => context.dataset.type === 'line' ? '#FF9500' : '#1e293b', 
                            anchor: (context) => context.dataset.type === 'line' ? 'start' : 'end',
                            align: (context) => context.dataset.type === 'line' ? 'top' : 'top', 
                            offset: (context) => context.dataset.type === 'line' ? 4 : -5,
                            font: { weight: 'bold', size: 10 },
                            formatter: (val) => val > 0 ? val.toLocaleString('id-ID') : ''
                        }
                    }, 
                    scales:{ y:{display:false}, y1:{display:false, min:0, max:100}, x:{grid:{display:false}} } 
                }
            });

            // --- Monthly Chart (Uses dataByDate - Respects Filter) ---
            const days = {};
            // Last 30 days logic (Standard) OR based on selected range?
            // If user selects specific range, chart usually adapts. 
            // Current code generates last 30 days keys.
            // Let's stick to last 30 days logic for consistency with title "Performa 30 Hari"
            for(let i=29; i>=0; i--) {
                const d = new Date(); d.setDate(d.getDate()-i);
                const k = d.toISOString().split('T')[0];
                // Label DD/MM
                const label = d.getDate() + '/' + (d.getMonth()+1);
                days[k] = { label: label, total:0, ok:0 };
            }
            
            // Map dataByDate to these 30 days buckets
            // Note: If filter is "Yesterday", "30 Days" chart might look empty except yesterday. 
            // If we want "30 Days" to ALWAYS show last 30 days regardless of date filter, use dataAnnual. 
            // But usually "30 Days" chart is a specific view. 
            // Let's use dataAnnual for this too if it implies "Last 30 Days Trend" independent of the "Daily" table filter.
            // Actually, usually dashboard charts show broader context. Let's use dataAnnual (filtered only by Type/SS) for the 30-day chart too, to make it a true "Trend" chart.
            
            dataAnnual.forEach(r => { 
                const dateStr = r.date || (r.timestamp ? new Date(r.timestamp.seconds*1000).toISOString().split('T')[0] : '');
                if(days[dateStr]) { r.details?.forEach(d => { days[dateStr].total+=d.total; days[dateStr].ok+=d.ok; }); } 
            });
            
            const sortedKeys = Object.keys(days).sort();
            const lblD = sortedKeys.map(k=>days[k].label);
            const datD_Vol = sortedKeys.map(k=>days[k].total);
            const datD_SLA = sortedKeys.map(k=> days[k].total>0 ? ((days[k].ok/days[k].total)*100).toFixed(1) : 0);

            if(chartMonthly) chartMonthly.destroy();
            chartMonthly = new Chart(chartMonthlyCanvas, {
                type: 'bar',
                data: { labels: lblD, datasets: [{ type:'bar', label:'Vol', data:datD_Vol, backgroundColor:'#34C759', borderRadius:4, order:2 }, { type:'line', label:'% SLA', data:datD_SLA, borderColor:'#007AFF', borderWidth:3, tension:0.3, pointRadius:3, yAxisID:'y1', order:1 }] },
                options: { 
                    layout: { padding: { top: 20 } },
                    responsive:true, maintainAspectRatio:false, 
                    plugins:{ 
                        legend:{display:false},
                        datalabels: {
                            color: (context) => context.dataset.type === 'line' ? '#007AFF' : '#1e293b', 
                            anchor: (context) => context.dataset.type === 'line' ? 'start' : 'end',
                            align: (context) => context.dataset.type === 'line' ? 'top' : 'top', 
                            offset: (context) => context.dataset.type === 'line' ? 4 : -5,
                            font: { weight: 'bold', size: 9 },
                            formatter: (val) => val > 0 ? val.toLocaleString('id-ID') : ''
                        }
                    }, 
                    scales:{ y:{display:false}, y1:{display:false, min:0, max:100}, x:{grid:{display:false}} } 
                }
            });
        }

        function processBreakdowns(data, filterSvc, filterType) {
            const byService = {}, byStaging = {};
            data.forEach(r => {
                const type = r.type; 
                r.details?.forEach(d => {
                    if (filterSvc !== 'all' && d.label !== filterSvc) return;
                    if(!byService[d.label]) byService[d.label] = { total:0, ok:0, inp:0, mbh:0, miss:0, claim:0, type: type };
                    else if(byService[d.label].type !== type) byService[d.label].type = 'mixed';
                    const s = byService[d.label]; s.total+=d.total; s.ok+=d.ok; s.inp+=d.inprogress; s.mbh+=d.mbh; s.miss+=d.missed; s.claim+=d.claimed;
                    const key = `${r.kodeSS} - ${r.reporterName}`;
                    if(!byStaging[key]) byStaging[key] = { name:key, total:0, ok:0, inp:0, mbh:0, miss:0, claim:0, type: type };
                    else if(byStaging[key].type !== type) byStaging[key].type = 'mixed';
                    const ss = byStaging[key]; ss.total+=d.total; ss.ok+=d.ok; ss.inp+=d.inprogress; ss.mbh+=d.mbh; ss.miss+=d.missed; ss.claim+=d.claimed;
                });
            });

            const showClaim = filterType !== 'pickup';
            document.querySelectorAll('.claim-col').forEach(el => el.style.display = showClaim ? 'table-cell' : 'none');

            const renderRow = (label, d) => {
                const sla = d.total > 0 ? (d.ok / d.total * 100) : 0;
                const slaColor = getSLAColor(sla, d.type);
                return `<tr class="hover:bg-black/5 border-b border-black/5">
                    <td class="p-3 pl-4 font-bold text-slate-700">${label}</td>
                    <td class="p-3 col-metric font-bold text-slate-800">${d.total.toLocaleString('id-ID')}</td>
                    <td class="p-3 col-metric font-medium text-slate-600">${d.ok.toLocaleString('id-ID')}</td>
                    <td class="p-3 col-metric text-center"><div class="${slaColor} text-[10px] text-white font-bold px-2 py-0.5 rounded-full inline-block">${sla.toLocaleString('id-ID', {maximumFractionDigits:1})}%</div></td>
                    <td class="p-3 col-metric text-slate-500">${d.inp.toLocaleString('id-ID')}</td>
                    <td class="p-3 col-metric text-orange-500">${d.mbh.toLocaleString('id-ID')}</td>
                    <td class="p-3 col-metric text-red-500 font-bold">${d.miss.toLocaleString('id-ID')}</td>
                    <td class="p-3 col-metric pr-4 text-purple-600 font-medium ${showClaim?'':'hidden'}">${d.claim.toLocaleString('id-ID')}</td>
                </tr>`;
            };

            const renderFooter = (list) => {
                let t=0, o=0, i=0, mb=0, m=0, c=0;
                list.forEach(x => { t+=x.total; o+=x.ok; i+=x.inp; mb+=x.mbh; m+=x.miss; c+=x.claim; });
                
                // Hitung Rata-rata %OK Total
                const avgPct = t > 0 ? (o / t * 100) : 0;
                const avgColor = getSLAColor(avgPct, filterType);

                return `<tr class="bg-slate-200/50 font-bold text-slate-800 border-t-2 border-slate-300">
                    <td class="p-3 pl-4">TOTAL</td>
                    <td class="p-3 col-metric">${t.toLocaleString('id-ID')}</td>
                    <td class="p-3 col-metric">${o.toLocaleString('id-ID')}</td>
                    <td class="p-3 col-metric text-center"><div class="${avgColor} text-[10px] text-white font-bold px-2 py-0.5 rounded-full inline-block">${avgPct.toLocaleString('id-ID', {maximumFractionDigits:1})}%</div></td>
                    <td class="p-3 col-metric">${i.toLocaleString('id-ID')}</td>
                    <td class="p-3 col-metric">${mb.toLocaleString('id-ID')}</td>
                    <td class="p-3 col-metric text-red-600">${m.toLocaleString('id-ID')}</td>
                    <td class="p-3 col-metric pr-4 ${showClaim?'':'hidden'}">${c.toLocaleString('id-ID')}</td>
                </tr>`;
            }

            const listSvc = Object.entries(byService).map(([k,v]) => ({label:k, ...v})).sort((a,b)=>b.total - a.total);
            const elSvc = document.getElementById('body-breakdown-service');
            if (elSvc) {
                elSvc.innerHTML = listSvc.map(item => renderRow(item.label, item)).join('');
                document.getElementById('foot-breakdown-service').innerHTML = renderFooter(listSvc);
            }

            const listStg = Object.values(byStaging).sort((a,b)=>b.total - a.total);
            const elStg = document.getElementById('body-breakdown-staging');
            if (elStg) {
                elStg.innerHTML = listStg.map(item => renderRow(item.name, item)).join('');
                document.getElementById('foot-breakdown-staging').innerHTML = renderFooter(listStg);
            }
        }

        function getSLAColor(pct, type) {
            let color = 'bg-[#FF3B30]';
            if(type === 'pickup') { if(pct > 95) color = 'bg-[#34C759]'; else if(pct >= 93) color = 'bg-[#FF9500]'; } 
            else { if(pct > 96.3) color = 'bg-[#34C759]'; else if(pct >= 95) color = 'bg-[#FF9500]'; }
            return color;
        }

        function processFeedback(data) {
            const feedInt = {}, feedExt = {}; let totInt = 0, totExt = 0;
            data.forEach(r => { r.details?.forEach(d => {
                    if(d.total_int > 0) totInt += d.total_int;
                    if(d.feed_int && d.feed_int.trim() !== '-' && d.feed_int.trim() !== '') { const t = d.feed_int.trim().toLowerCase(); feedInt[t] = (feedInt[t] || 0) + d.total_int; }
                    if(d.total_ext > 0) totExt += d.total_ext;
                    if(d.feed_ext && d.feed_ext.trim() !== '-' && d.feed_ext.trim() !== '') { const t = d.feed_ext.trim().toLowerCase(); feedExt[t] = (feedExt[t] || 0) + d.total_ext; }
            });});
            document.getElementById('feedback-total-int').textContent = totInt;
            document.getElementById('feedback-total-ext').textContent = totExt;
            const render = (obj) => Object.entries(obj).map(([k,v]) => `<li class="flex justify-between border-b border-black/5 pb-1"><span class="capitalize text-slate-600 truncate mr-2 w-32">${k}</span><span class="font-bold text-slate-800">${v}</span></li>`).join('') || '<li class="text-slate-400 italic text-xs">Kosong</li>';
            document.getElementById('feedback-list-int').innerHTML = render(feedInt);
            document.getElementById('feedback-list-ext').innerHTML = render(feedExt);
        }

        function setupReportForm() {
            document.getElementById('input-date').valueAsDate = new Date();
            const isCoord = currentUser.role === 'coordinator';
            document.getElementById('admin-user-select-container').classList.toggle('hidden', !isCoord);
            document.getElementById('input-pic-name').readOnly = !isCoord; 
            
            if(isCoord) populateAdminUserSelect();
            else {
                document.getElementById('input-pic-name').value = currentUser.name;
                document.getElementById('input-pic-id').value = currentUser.id;
                document.getElementById('input-kode-ss').value = currentUser.kodeSS || '-';
            }
        }
        function populateAdminUserSelect() {
            const sel = document.getElementById('input-admin-select-user');
            sel.innerHTML = '<option value="">-- Pilih --</option>';
            allUsers.filter(u=>u.username!=='admin' && u.status!=='inactive').forEach(u => sel.innerHTML += `<option value="${u.id}">${u.name} (${u.kodeSS||'-'})</option>`);
        }
        window.updateReporterInfo = () => {
            const uid = document.getElementById('input-admin-select-user').value;
            if(!uid) return;
            const u = allUsers.find(x=>x.id===uid);
            document.getElementById('input-pic-name').value = u.name;
            document.getElementById('input-kode-ss').value = u.kodeSS || '-';
            document.getElementById('input-pic-id').value = u.id;
        }

        // --- NEW: Toggle Report Form View ---
        window.toggleReportForm = (show) => {
            if(show) {
                document.getElementById('view-reports-list').classList.add('hidden');
                document.getElementById('view-reports-form').classList.remove('hidden');
                renderInputTable();
            } else {
                document.getElementById('view-reports-form').classList.add('hidden');
                document.getElementById('view-reports-list').classList.remove('hidden');
            }
        }

        // --- NEW: Select Report Type with Icons ---
        window.selectReportType = (type) => {
            document.getElementById('input-type').value = type;
            const btnDel = document.getElementById('btn-type-delivery');
            const btnPick = document.getElementById('btn-type-pickup');
            
            if(type === 'delivery') {
                btnDel.classList.remove('text-slate-500');
                btnDel.classList.add('bg-blue-50', 'text-[#007AFF]', 'border-blue-200'); // Blue
                btnPick.classList.add('text-slate-500');
                btnPick.classList.remove('bg-orange-50', 'text-[#FF9500]', 'border-orange-200');
            } else {
                btnPick.classList.remove('text-slate-500');
                btnPick.classList.add('bg-orange-50', 'text-[#FF9500]', 'border-orange-200'); // Orange
                btnDel.classList.add('text-slate-500');
                btnDel.classList.remove('bg-blue-50', 'text-[#007AFF]', 'border-blue-200');
            }
            renderInputTable();
        }

        // --- NEW: Number Formatting Helper ---
        window.formatNumberInput = (input) => {
            let val = input.value.replace(/\D/g, ''); // Remove non-digits
            if (val) {
                val = parseInt(val, 10).toLocaleString('id-ID'); // Format 1.000
            }
            input.value = val;
        }

        window.renderInputTable = () => {
            const isDel = document.getElementById('input-type').value === 'delivery';
            let head = `<tr>
                <th class="p-3 border-b border-slate-200 w-24">Layanan</th>
                <th class="p-3 border-b border-slate-200 bg-blue-50 text-blue-600 w-20">Total</th>
                <th class="p-3 border-b border-slate-200 w-16">OK</th>
                <th class="p-3 border-b border-slate-200 text-xs text-slate-400 w-16">P</th>
                <th class="p-3 border-b border-slate-200 text-xs text-slate-400 w-16">M</th>
                <th class="p-3 border-b border-slate-200 text-xs text-red-500 w-16">Mis</th>
                ${isDel?'<th class="p-3 border-b border-slate-200 text-xs w-16">Clm</th>':''}
                <th class="p-3 border-b border-slate-200 border-l pl-2 text-xs w-16">In</th>
                <th class="p-3 border-b border-slate-200 text-xs w-auto">Ket</th>
                <th class="p-3 border-b border-slate-200 text-xs w-16">Ex</th>
                <th class="p-3 border-b border-slate-200 text-xs w-auto">Ket</th>
            </tr>`;
            document.getElementById('table-header').innerHTML = head;
            let body = '';
            ROW_LABELS.forEach((lbl, i) => {
                const rid = `row-${i}`;
                body += `<tr data-label="${lbl}" class="border-b border-slate-100 last:border-0">
                    <td class="p-2 font-bold text-slate-600 text-xs bg-slate-50/50">${lbl}</td>
                    <td class="p-2 total-cell input-cell"><input type="text" id="${rid}-total" readonly value="0"></td>
                    <td class="p-2 input-cell"><input type="text" class="sla-input" data-row="${rid}" oninput="formatNumberInput(this); calcRow('${rid}')"></td>
                    <td class="p-2 input-cell"><input type="text" class="sla-input" data-row="${rid}" oninput="formatNumberInput(this); calcRow('${rid}')"></td>
                    <td class="p-2 input-cell"><input type="text" class="sla-input" data-row="${rid}" oninput="formatNumberInput(this); calcRow('${rid}')"></td>
                    <td class="p-2 input-cell"><input type="text" class="sla-input" data-row="${rid}" oninput="formatNumberInput(this); calcRow('${rid}')"></td>
                    ${isDel ? `<td class="p-2 input-cell"><input type="text" class="sla-input" data-row="${rid}" oninput="formatNumberInput(this); calcRow('${rid}')"></td>` : ''}
                    <td class="p-2 input-cell border-l pl-2"><input type="text" oninput="formatNumberInput(this)"></td>
                    <td class="p-2"><input type="text" class="w-full text-xs bg-transparent border-b border-slate-200 outline-none"></td>
                    <td class="p-2 input-cell"><input type="text" oninput="formatNumberInput(this)"></td>
                    <td class="p-2"><input type="text" class="w-full text-xs bg-transparent border-b border-slate-200 outline-none"></td>
                </tr>`;
            });
            document.getElementById('table-body').innerHTML = body;
        }

        window.calcRow = (rid) => {
            let tot = 0;
            // Handle formatted inputs (strip dots)
            document.querySelectorAll(`input.sla-input[data-row="${rid}"]`).forEach(i => {
                const val = parseInt(i.value.replace(/\./g, '')) || 0;
                tot += val;
            });
            document.getElementById(`${rid}-total`).value = tot.toLocaleString('id-ID');
        }

        document.getElementById('report-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-submit-report');
            const editId = document.getElementById('report-id-hidden').value;
            const date = document.getElementById('input-date').value;
            const type = document.getElementById('input-type').value;
            const picId = document.getElementById('input-pic-id').value;
            const picName = document.getElementById('input-pic-name').value;
            const kodeSS = document.getElementById('input-kode-ss').value;

            if(!picId || !date) return showNotification("Identitas/Tanggal kosong", "error");
            if(!editId) {
                const qDup = query(collection(db,'artifacts', appId, 'public', 'data', 'reports'), where('reporterId','==',picId), where('date','==',date), where('type','==',type));
                const dupSnap = await getDocs(qDup);
                if(!dupSnap.empty) return showNotification(`Laporan ${type} tanggal ${date} sudah ada!`, "error");
            }
            
            let gTotal = 0; 
            const details = [];
            
            document.querySelectorAll('#table-body tr').forEach(tr => {
                const inps = tr.querySelectorAll('input'); 
                const isDel = type === 'delivery';
                
                // Helper to get raw integer value from formatted input
                const getVal = (idx) => {
                    if (!inps[idx]) return 0;
                    return parseInt(inps[idx].value.replace(/\./g, '')) || 0;
                };
                
                // Helper to get string value
                const getStr = (idx) => inps[idx] ? inps[idx].value : '';

                const tot = getVal(0);
                gTotal += tot;
                
                // Index mapping depends on delivery/pickup columns
                // 0: Total, 1: OK, 2: Inp, 3: MBH, 4: Miss
                // If Del: 5: Claim, 6: IntTot, 7: IntKet, 8: ExtTot, 9: ExtKet
                // If Pick: 5: IntTot, 6: IntKet, 7: ExtTot, 8: ExtKet

                details.push({
                    label: tr.getAttribute('data-label'),
                    total: tot, 
                    ok: getVal(1), 
                    inprogress: getVal(2), 
                    mbh: getVal(3), 
                    missed: getVal(4),
                    claimed: isDel ? getVal(5) : 0,
                    
                    total_int: isDel ? getVal(6) : getVal(5), 
                    feed_int: isDel ? getStr(7) : getStr(6),
                    
                    total_ext: isDel ? getVal(8) : getVal(7), 
                    feed_ext: isDel ? getStr(9) : getStr(8)
                });
            });
            
            btn.disabled = true; 
            const originalContent = btn.innerHTML; 
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Loading...';
            
            try {
                const payload = { date, type, reporterName: picName, reporterId: picId, kodeSS, grandTotalVolume: gTotal, details, timestamp: serverTimestamp() };
                if(editId) { 
                    await updateDoc(doc(db,'artifacts', appId, 'public', 'data', 'reports', editId), payload); 
                    showNotification("Data diperbarui!"); 
                    btn.innerHTML = originalContent;
                    window.cancelEditMode(); 
                    toggleReportForm(false);
                }
                else { 
                    await addDoc(collection(db,'artifacts', appId, 'public', 'data', 'reports'), payload); 
                    showNotification("Laporan tersimpan!"); 
                    btn.innerHTML = originalContent;
                    document.getElementById('report-form').reset(); 
                    setupReportForm(); 
                    renderInputTable(); 
                    toggleReportForm(false);
                }
            } catch(e) { 
                console.error(e); 
                showNotification("Gagal menyimpan", "error"); 
                btn.innerHTML = originalContent;
            }
            btn.disabled = false; 
        });

        window.requestEditReport = (id) => { 
            // If user is leader, check ownership handled by UI hiding/auth logic, but here assume if they see button they can click it.
            // Actually requestEditReport just loads form.
            if(currentUser.role==='coordinator') {
                loadReportToForm(id); 
            } else {
                // For Leader, we need to authorize. But wait, `openAuthModal` was for critical actions. 
                // Editing own report should be allowed directly? Or use Auth? 
                // Previous logic used Auth modal for critical actions. Let's keep it consistent.
                // However, user usually edits their own report. 
                // Let's assume Leader can edit directly if it's their report, but logic below uses Auth Modal for delete.
                // For Edit, let's allow direct edit if it's their own, or require auth if not?
                // The previous code used `openAuthModal('editReport', id)`. I will keep it for safety as requested "Admin password required".
                openAuthModal('editReport', id); 
            }
        }
        window.requestDeleteReport = (id) => { if(currentUser.role==='coordinator') openConfirmDelete(id); else openAuthModal('deleteReport', id); }
        
        function loadReportToForm(id) {
            const r = allReports.find(x => x.id === id); if(!r) return;
            // Switch to form view
            toggleReportForm(true);
            
            document.getElementById('report-id-hidden').value = r.id;
            document.getElementById('input-date').value = r.date;
            
            // Set Type Segmented Control
            selectReportType(r.type);
            
            if(currentUser.role === 'coordinator') { document.getElementById('input-admin-select-user').value = r.reporterId; updateReporterInfo(); }
            document.getElementById('edit-mode-indicator').classList.remove('hidden');
            document.getElementById('btn-submit-text').textContent = "Update Laporan";
            
            // Populate Table
            // Wait for renderInputTable to finish? It is synchronous.
            const rows = document.querySelectorAll('#table-body tr');
            r.details?.forEach(d => {
                rows.forEach(tr => {
                    if(tr.getAttribute('data-label') === d.label) {
                        const inps = tr.querySelectorAll('input'); 
                        const isDel = r.type === 'delivery';
                        
                        // Populate with formatted strings
                        const setVal = (idx, val) => {
                             if(inps[idx]) inps[idx].value = val ? val.toLocaleString('id-ID') : '';
                        };
                        const setStr = (idx, val) => {
                            if(inps[idx]) inps[idx].value = val || '';
                        }

                        setVal(1, d.ok); 
                        setVal(2, d.inprogress); 
                        setVal(3, d.mbh); 
                        setVal(4, d.missed);
                        
                        if(isDel) setVal(5, d.claimed);
                        
                        const off = isDel ? 6 : 5;
                        setVal(off, d.total_int); 
                        setStr(off+1, d.feed_int); 
                        setVal(off+2, d.total_ext); 
                        setStr(off+3, d.feed_ext);
                        
                        calcRow(tr.querySelector('.sla-input').getAttribute('data-row'));
                    }
                })
            });
            document.getElementById('view-reports-form').scrollIntoView({behavior: 'smooth'});
        }
        window.cancelEditMode = () => {
            document.getElementById('report-form').reset();
            document.getElementById('report-id-hidden').value = '';
            document.getElementById('edit-mode-indicator').classList.add('hidden');
            
            // Reset to default type
            selectReportType('delivery');
            
            const btnText = document.getElementById('btn-submit-text');
            if (btnText) {
                btnText.textContent = "Simpan Laporan";
            }
            
            setupReportForm(); renderInputTable();
        }

        function listenToReports() {
            if(!auth.currentUser) return;
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'reports'));
            reportsUnsubscribe = onSnapshot(q, (s) => { 
                let rawDocs = s.docs.map(d=>({id:d.id, ...d.data()}));
                rawDocs.sort((a,b) => {
                    const tA = a.timestamp ? a.timestamp.seconds : 0;
                    const tB = b.timestamp ? b.timestamp.seconds : 0;
                    return tB - tA;
                });
                allReports = rawDocs;
                renderDashboard(); setupDashboardFilters(); renderReportsTable(); updateFilterUser(); 
            }, (error) => console.error("Reports listener error", error));
        }
        function listenToUsers() {
            if(!auth.currentUser) return;
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), (s) => { 
                allUsers = s.docs.map(d=>({id:d.id, ...d.data()})); renderUsersTable(); if(currentUser.role === 'coordinator') populateAdminUserSelect(); 
            }, (error) => console.error("Users listener error", error));
        }

        function renderReportsTable() {
            const f = document.getElementById('filter-user').value; let d = allReports;
            if(f !== 'all') d = d.filter(x => x.reporterName === f);
            
            document.getElementById('reports-table-body').innerHTML = d.map(r => {
                const date = r.date ? new Date(r.date).toLocaleDateString('id-ID') : '-';
                
                // Build Detail Breakdown Grid with Columns
                let detailsHTML = '<div class="space-y-1">';
                let hasDetails = false;
                
                // Collect Feedbacks
                let feedbacks = [];

                r.details?.forEach(d => {
                    if(d.total > 0) {
                        hasDetails = true;
                        // Format: Svc | Tot | OK | Pr | Ms | Cl
                        detailsHTML += `
                        <div class="grid grid-cols-12 gap-1 text-[10px] items-center border-b border-dashed border-slate-100 pb-0.5 last:border-0">
                            <div class="col-span-2 font-bold text-slate-700 truncate" title="${d.label}">${d.label}</div>
                            <div class="col-span-2 text-right font-mono bg-blue-50 text-blue-600 rounded px-0.5">${d.total.toLocaleString()}</div>
                            <div class="col-span-2 text-right font-mono text-green-600">${d.ok.toLocaleString()}</div>
                            <div class="col-span-2 text-right font-mono text-slate-400">${d.inprogress.toLocaleString()}</div>
                            <div class="col-span-2 text-right font-mono text-red-500 font-bold">${d.missed > 0 ? d.missed.toLocaleString() : '-'}</div>
                            <div class="col-span-2 text-right font-mono text-purple-500 font-bold">${d.claimed > 0 ? d.claimed.toLocaleString() : '-'}</div>
                        </div>`;

                        if(d.feed_int) feedbacks.push(`<span class="text-blue-600 font-bold text-[9px]">[In] ${d.label}:</span> ${d.feed_int}`);
                        if(d.feed_ext) feedbacks.push(`<span class="text-orange-600 font-bold text-[9px]">[Ex] ${d.label}:</span> ${d.feed_ext}`);
                    }
                });
                detailsHTML += '</div>';
                
                // Headers for the mini table inside the cell
                const miniHeader = `
                <div class="grid grid-cols-12 gap-1 text-[9px] font-bold text-slate-400 border-b border-slate-200 pb-1 mb-1">
                    <div class="col-span-2">Svc</div>
                    <div class="col-span-2 text-right">Tot</div>
                    <div class="col-span-2 text-right">OK</div>
                    <div class="col-span-2 text-right">Prg</div>
                    <div class="col-span-2 text-right">Mss</div>
                    <div class="col-span-2 text-right">Clm</div>
                </div>`;

                if (!hasDetails) detailsHTML = '<span class="text-slate-400 italic text-[10px]">Tidak ada data volume</span>';
                else detailsHTML = miniHeader + detailsHTML;

                // Calculate Totals for Int/Ext
                let totInt = 0, totExt = 0;
                r.details?.forEach(x => { totInt += (x.total_int || 0); totExt += (x.total_ext || 0); });

                return `<tr class="border-b border-black/5 last:border-0 align-top hover:bg-slate-50/50 transition-colors">
                    <td class="p-3 text-[10px] font-mono text-slate-500 font-medium">${date}</td>
                    <td class="p-3">
                        <div class="font-bold text-slate-800 text-xs">${r.reporterName}</div>
                        <div class="text-[9px] text-slate-500 font-mono font-bold mt-0.5 uppercase tracking-wide bg-slate-100 inline-block px-1 rounded">${r.kodeSS||'-'}</div>
                    </td>
                    <td class="p-3">
                        <span class="px-2 py-0.5 rounded-full text-[9px] font-bold uppercase border ${r.type==='delivery'?'bg-blue-50 text-blue-600 border-blue-100':'bg-orange-50 text-orange-600 border-orange-100'}">${r.type.substr(0,3)}</span>
                    </td>
                    <td class="p-3">${detailsHTML}</td>
                    <td class="p-3 text-center text-xs font-bold text-blue-600">${totInt > 0 ? totInt.toLocaleString() : '-'}</td>
                    <td class="p-3 text-center text-xs font-bold text-orange-600">${totExt > 0 ? totExt.toLocaleString() : '-'}</td>
                    <td class="p-3 text-[10px] text-slate-600 leading-tight">
                        ${feedbacks.length > 0 ? feedbacks.join('<br>') : '<span class="text-slate-300 italic">-</span>'}
                    </td>
                    <td class="p-3 text-center">
                        <div class="flex flex-col gap-2 items-center justify-center">
                            <button onclick="requestEditReport('${r.id}')" class="text-blue-500 hover:bg-blue-50 p-1.5 rounded-lg transition-colors"><i class="fa-solid fa-pen-to-square"></i></button>
                            <button onclick="requestDeleteReport('${r.id}')" class="text-red-400 hover:bg-red-50 p-1.5 rounded-lg transition-colors"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    </td>
                </tr>`;
            }).join('') || '<tr><td colspan="8" class="p-8 text-center text-slate-400 italic text-xs">Belum ada laporan masuk</td></tr>';
        }
        
        function updateFilterUser() {
            const sel = document.getElementById('filter-user'); const cur = sel.value;
            sel.innerHTML = '<option value="all">Semua PIC</option>' + [...new Set(allReports.map(r=>r.reporterName))].map(n=>`<option>${n}</option>`).join('');
            sel.value = cur;
        }

        window.toggleUserStatus = async (id, currentStatus) => {
            const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
            try { await updateDoc(doc(db,'artifacts', appId, 'public', 'data', 'users', id), {status: newStatus}); showNotification("Status diubah"); } catch(e) { showNotification("Gagal", "error"); }
        }
        function renderUsersTable() {
            const tbody = document.getElementById('users-table-body');
            if (allUsers.length === 0) { tbody.innerHTML = `<tr><td colspan="4" class="p-6 text-center text-slate-400 italic">Kosong</td></tr>`; return; }
            tbody.innerHTML = allUsers.map(u => {
                const isActive = u.status !== 'inactive';
                const toggleBtn = (u.username !== 'admin' && u.id !== currentUser.id)
                    ? `<button onclick="toggleUserStatus('${u.id}', '${isActive?'active':'inactive'}')" class="relative inline-flex items-center h-5 rounded-full w-9 transition-colors focus:outline-none ${isActive ? 'bg-[#34C759]' : 'bg-slate-300'}"><span class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform shadow-sm ${isActive ? 'translate-x-4' : 'translate-x-0.5'}"></span></button>`
                    : `<span class="text-[9px] text-slate-300 font-bold bg-slate-100 px-1 rounded">LOCKED</span>`;
                return `<tr class="border-b border-black/5 ${!isActive?'opacity-50 grayscale':''}">
                    <td class="p-4 font-bold text-slate-700">${u.name}<br><span class="text-[10px] text-slate-400 font-normal">ID: ${u.username}</span></td>
                    <td class="p-4"><span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase bg-slate-100 text-slate-500">${u.role}</span></td>
                    <td class="p-4 text-center">${toggleBtn}</td>
                    <td class="p-4 text-center"><div class="flex justify-center gap-3"><button onclick="editUser('${u.id}')" class="text-blue-500"><i class="fa-solid fa-pen"></i></button>${u.id!==currentUser.id && u.username!=='admin' ? `<button onclick="openDeleteModal('${u.id}', '${u.username}')" class="text-red-400"><i class="fa-solid fa-trash"></i></button>` : ''}</div></td>
                </tr>`;
            }).join('');
        }

        window.editUser = (id) => {
            const u = allUsers.find(x=>x.id===id); if(!u) return;
            document.getElementById('edit-user-id').value = u.id; document.getElementById('new-role').value = u.role;
            document.getElementById('new-account-status').value = u.status || 'active'; document.getElementById('new-name').value = u.name;
            document.getElementById('new-username').value = u.username; document.getElementById('new-password').value = u.password;
            document.getElementById('new-kode-ss').value = u.kodeSS||''; document.getElementById('new-kota').value = u.kotaArea||'';
            const isAdm = u.username === 'admin';
            document.getElementById('new-username').readOnly = isAdm; document.getElementById('new-role').disabled = isAdm; document.getElementById('new-account-status').disabled = isAdm;
            toggleFormFields(); document.getElementById('modal-title').textContent = "Edit User"; document.getElementById('modal-add-user').classList.remove('hidden');
        }
        window.prepareAddUser = () => { 
            document.getElementById('add-user-form').reset(); document.getElementById('edit-user-id').value=''; 
            document.getElementById('new-role').disabled = false; document.getElementById('new-username').readOnly = false;
            document.getElementById('new-account-status').disabled = false; document.getElementById('modal-title').textContent = "User Baru";
            document.getElementById('modal-add-user').classList.remove('hidden'); 
        }
        window.closeAddUserModal = () => document.getElementById('modal-add-user').classList.add('hidden');
        window.toggleFormFields = () => { const r = document.getElementById('new-role').value; document.getElementById('leader-fields').classList.toggle('hidden', r==='coordinator'); }
        
        document.getElementById('add-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const uid = document.getElementById('edit-user-id').value;
            const roleEl = document.getElementById('new-role'); const statusEl = document.getElementById('new-account-status');
            const roleVal = roleEl.disabled ? 'coordinator' : roleEl.value; const statusVal = statusEl.disabled ? 'active' : statusEl.value;
            const rawUsername = document.getElementById('new-username').value;
            const cleanUsername = rawUsername.trim().toLowerCase();
            const cleanPassword = document.getElementById('new-password').value.trim();
            if (!/^\d+$/.test(cleanUsername) && cleanUsername !== 'admin') { showNotification("ID harus berupa angka!", "error"); return; }
            if (cleanPassword.length < 6) { showNotification("Password minimal 6 karakter!", "error"); return; }
            const data = { role: roleVal, name: document.getElementById('new-name').value, username: cleanUsername, password: cleanPassword, kodeSS: document.getElementById('new-kode-ss').value, kotaArea: document.getElementById('new-kota').value, status: statusVal };
            if(!uid) data.createdAt = serverTimestamp();
            try { 
                if(!uid) {
                    const qCheck = query(collection(db, 'artifacts', appId, 'public', 'data', 'users'), where("username", "==", cleanUsername));
                    const snapCheck = await getDocs(qCheck);
                    if(!snapCheck.empty) { showNotification("ID sudah dipakai!", "error"); return; }
                }
                if(uid) await updateDoc(doc(db,'artifacts', appId, 'public', 'data', 'users', uid), data); else await addDoc(collection(db,'artifacts', appId, 'public', 'data', 'users'), data); showNotification("Tersimpan!"); closeAddUserModal(); 
            } catch(e) { showNotification("Gagal", "error"); }
        });

        window.openAuthModal = (action, id) => { targetId = id; pendingAction = action; document.getElementById('auth-code-input').value=''; document.getElementById('modal-auth-code').classList.remove('hidden'); setTimeout(() => document.getElementById('auth-code-input').focus(), 100); }
        window.closeAuthModal = () => document.getElementById('modal-auth-code').classList.add('hidden');
        window.verifyAuthCode = () => { if(document.getElementById('auth-code-input').value === currentAdminCode) { closeAuthModal(); if(pendingAction === 'deleteReport') openConfirmDelete(targetId); if(pendingAction === 'editReport') loadReportToForm(targetId); } else showNotification("Kode Salah", "error"); }
        function openConfirmDelete(id, username) { targetId = id; pendingAction = username ? 'deleteUser' : 'deleteReport'; document.getElementById('delete-confirmation-text').textContent = username ? `Hapus user ${username}?` : "Hapus laporan ini?"; document.getElementById('modal-confirm-delete').classList.remove('hidden'); }
        window.openDeleteModal = openConfirmDelete; window.closeDeleteModal = () => document.getElementById('modal-confirm-delete').classList.add('hidden');
        window.executeDelete = async () => { try { if(pendingAction === 'deleteReport') await deleteDoc(doc(db,'artifacts', appId, 'public', 'data', 'reports', targetId)); if(pendingAction === 'deleteUser') await deleteDoc(doc(db,'artifacts', appId, 'public', 'data', 'users', targetId)); showNotification("Dihapus."); closeDeleteModal(); } catch(e) { showNotification("Gagal", "error"); } }

        window.showTab = (t) => {
            if (t === 'settings' && currentUser && currentUser.role !== 'coordinator') { showNotification("Akses ditolak!", "error"); return; }
            const tabs = ['dashboard', 'reports', 'settings'];
            tabs.forEach(x => { document.getElementById('tab-' + x).classList.add('hidden'); document.getElementById('nav-' + x).classList.remove('nav-active'); });
            document.getElementById('tab-' + t).classList.remove('hidden'); document.getElementById('nav-' + t).classList.add('nav-active');
        }

        switchLoginTab('user');
    </script>
</body>
</html>